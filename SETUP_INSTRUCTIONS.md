# Инструкции по настройке системы вопросов

## Обзор изменений

Реализована полная интеграция между фронтендом и базой данных для динамической загрузки вопросов:

### ✅ Что сделано:

1. **Создан API сервер** (`bot/web_app.py`):
   - `/api/user/{telegram_id}/current-question` - получение текущего вопроса
   - `/api/user/{telegram_id}/answer` - сохранение ответа и переход к следующему вопросу
   - `/api/user/{telegram_id}/progress` - прогресс пользователя
   - `/api/user/{telegram_id}/profile` - обновление профиля

2. **Обновлена страница вопросов** (`frontend/question.html`):
   - Динамическая загрузка вопросов из API
   - Автоматическое сохранение ответов
   - Переход к следующему вопросу
   - Индикатор загрузки и прогресс

3. **Скрипты для запуска**:
   - `bot/setup_test_data.py` - настройка тестовых данных
   - `bot/run_web_server.py` - запуск веб-сервера

## Пошаговая настройка

### 1. Настройка окружения

```bash
# Переходим в директорию проекта
cd /Users/home/PycharmProjects/perplexy_bot

# Активируем виртуальное окружение
source venv/bin/activate

# Устанавливаем недостающие зависимости (если нужно)
pip install aiohttp
```

### 2. Настройка переменных окружения

Создайте файл `.env` в корне проекта:

```env
# Telegram Bot
BOT_TOKEN=your_bot_token_here

# Perplexity API
PERPLEXITY_API_KEY=your_perplexity_api_key_here

# База данных (SQLite по умолчанию)
DATABASE_URL=sqlite+aiosqlite:///./data/bot.db

# Robokassa (опционально)
ROBOKASSA_LOGIN=your_login
ROBOKASSA_PASSWORD=your_password
ROBOKASSA_PASSWORD2=your_password2
ROBOKASSA_TEST=1
```

### 3. Инициализация базы данных

```bash
# Настройка тестовых данных (создает БД и добавляет вопросы)
python bot/setup_test_data.py
```

Эта команда:
- Создаст таблицы в базе данных
- Добавит 15 вопросов (5 бесплатных + 10 платных)
- Создаст тестового пользователя

### 4. Запуск веб-сервера

```bash
# Запуск сервера с API и фронтендом
python bot/run_web_server.py
```

Сервер будет доступен по адресу: `http://localhost:8080`

### 5. Тестирование

Откройте в браузере: `http://localhost:8080/question.html`

#### Что должно происходить:
1. Страница загружает первый вопрос из базы данных
2. Пользователь вводит ответ
3. При нажатии "Следующий вопрос" ответ сохраняется в БД
4. Загружается следующий вопрос по порядку
5. Обновляется счетчик "Вопрос X из Y"
6. После всех вопросов - переход на страницу завершения

## Структура API

### GET `/api/user/{telegram_id}/current-question`
Возвращает текущий вопрос для пользователя:
```json
{
  "question": {
    "id": 1,
    "text": "Расскажите о себе...",
    "order_number": 1,
    "type": "free",
    "allow_voice": true,
    "max_length": 1000
  },
  "progress": {
    "current": 1,
    "total": 5,
    "answered": 0
  },
  "user": {
    "is_paid": false,
    "test_completed": false
  }
}
```

### POST `/api/user/{telegram_id}/answer`
Сохраняет ответ и возвращает следующий вопрос:
```json
{
  "text_answer": "Мой ответ на вопрос...",
  "answer_type": "text"
}
```

## Логика работы

1. **Загрузка вопроса**: При загрузке страницы вызывается API для получения текущего вопроса
2. **Сохранение ответа**: При отправке ответа происходит:
   - Сохранение в таблице `answers`
   - Анализ через Perplexity AI (асинхронно)
   - Получение следующего вопроса
   - Обновление `current_question_id` пользователя
3. **Завершение теста**: После последнего вопроса пользователь перенаправляется на страницу результатов

## Отладка

### Проверка логов
Сервер выводит подробные логи в консоль, включая:
- Загрузку вопросов
- Сохранение ответов
- Ошибки API

### Тестирование в браузере
1. Откройте DevTools (F12)
2. Во вкладке Console увидите логи JavaScript
3. Во вкладке Network - запросы к API

### Проверка базы данных
```bash
# Запуск SQL-консоли для проверки данных
sqlite3 data/bot.db

# Полезные запросы:
.tables
SELECT * FROM questions ORDER BY order_number;
SELECT * FROM users;
SELECT * FROM answers;
```

## Возможные проблемы

1. **"Question not found"** - база данных не инициализирована
   - Решение: запустите `python bot/setup_test_data.py`

2. **"Failed to get question"** - проблемы с API
   - Проверьте, что сервер запущен
   - Проверьте логи в консоли

3. **CORS ошибки** - проблемы с политикой безопасности
   - API настроен на прием запросов с любого origin для разработки

## Следующие шаги

После успешного тестирования можно:
1. Интегрировать с реальным Telegram Bot
2. Добавить обработку голосовых сообщений
3. Реализовать генерацию PDF отчетов
4. Настроить деплой на продакшн-сервер 