<!doctype html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <meta name="format-detection" content="telephone=no">
    <title>PRIZMA</title>
    <link rel="stylesheet" href="css/main.css">
    <script src="js/config.js?v=1735027890"></script>
    <script src="js/telegram-vanilla.js?v=1735027890"></script>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="telegram:cache" content="false">
</head>
<body class="bodyQuestion">

<main class="main question">
    <div class="question-header">
        <div class="question-prev-button-container">
            <a href="login.html" class="steps-header-button">
                <img src="./images/arrow-prev-icon.svg" alt="">
            </a>
            <h1 class="question-num linear-text">–í–æ–ø—Ä–æ—Å <span class="current-question">1</span> –∏–∑ <span class="question-count">5</span></h1>
        </div>
        <p class="question-title" id="questionText">–ó–∞–≥—Ä—É–∂–∞–µ–º –≤–æ–ø—Ä–æ—Å...</p>
    </div>
    <div class="question-area-container">
        <div class="write-icon">
            <span>...</span>
            <img src="./images/pencil-icon.svg" alt="">
        </div>
        <textarea name="" id="questionArea" class="question-area" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –æ—Ç–≤–µ—Ç..."></textarea>
        <button class="micro-button">
            <img src="./images/micro-icon.svg" alt="">
        </button>
    </div>
    <button class="button-triangle" id="nextButton" onclick="submitAnswer()" style="display: block;">
        <span>–°–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å</span>
        <img src="./images/button-triangle.svg" alt="">
    </button>
    
    <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ -->
    <div id="loadingIndicator" style="display: none; text-align: center; margin: 20px;">
        <p>‚è≥ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –≤–∞—à –æ—Ç–≤–µ—Ç...</p>
    </div>
</main>

<script src="js/jquery.min.js"></script>
<script src="./js/jquery-ui.min.js"></script>
<script src="js/main-telegram.js?v=1735027890"></script>
<script>
// API configuration
const API_BASE_URL = window.location.origin;
let currentTelegramId = null;
let currentQuestionData = null;

// –ü–æ–ª—É—á–∞–µ–º Telegram ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
function getTelegramUserId() {
    if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initDataUnsafe && window.Telegram.WebApp.initDataUnsafe.user) {
        return window.Telegram.WebApp.initDataUnsafe.user.id;
    }
    // –î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è - –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π ID
    const testId = localStorage.getItem('test_telegram_id');
    if (testId) {
        return parseInt(testId);
    }
    return 123456789;
}

// –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ –≤–æ–ø—Ä–æ—Å–∞
async function loadCurrentQuestion() {
    try {
        currentTelegramId = getTelegramUserId();
        console.log('Loading question for user:', currentTelegramId);
        console.log('API_BASE_URL:', API_BASE_URL);
        
        if (!currentTelegramId) {
            throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å Telegram ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
        }
        
        const response = await fetch(`${API_BASE_URL}/api/user/${currentTelegramId}/current-question`);
        console.log('Response status:', response.status);
        
        const data = await response.json();
        console.log('Response data:', data);
        
        if (response.ok) {
            currentQuestionData = data;
            displayQuestion(data);
        } else {
            console.error('Error loading question:', data.error);
            $('#questionText').text('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–æ–ø—Ä–æ—Å–∞: ' + (data.error || data.detail || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
        }
    } catch (error) {
        console.error('Error loading question:', error);
        $('#questionText').text('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–æ–ø—Ä–æ—Å–∞: ' + error.message);
    }
}

// –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤–æ–ø—Ä–æ—Å–∞
function displayQuestion(data) {
    const { question, progress, user } = data;
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞
    $('#questionText').text(question.text);
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –≤–æ–ø—Ä–æ—Å–æ–≤
    $('.current-question').text(progress.current);
    $('.question-count').text(progress.total);
    
    // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º textarea
    const textarea = $('#questionArea');
    textarea.val('');
    textarea.attr('maxlength', question.max_length || 1000);
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–∏–ø–µ –∞–∫–∫–∞—É–Ω—Ç–∞
    if (!user.is_paid && question.type === 'paid') {
        $('#questionText').append('<br><small style="color: #ff6b6b;">üíé –≠—Ç–æ—Ç –≤–æ–ø—Ä–æ—Å –¥–æ—Å—Ç—É–ø–µ–Ω –≤ –ø—Ä–µ–º–∏—É–º-–≤–µ—Ä—Å–∏–∏</small>');
    }
    
    console.log('Question loaded:', question);
}

// –û—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç–≤–µ—Ç–∞
async function submitAnswer() {
    const answerText = $('#questionArea').val().trim();
    
    if (!answerText) {
        if (window.TelegramWebApp && window.TelegramWebApp.showAlert) {
            window.TelegramWebApp.showAlert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –æ—Ç–≤–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å');
        } else {
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –æ—Ç–≤–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å');
        }
        return;
    }
    
    if (!currentTelegramId) {
        const errorMsg = '–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è';
        if (window.TelegramWebApp && window.TelegramWebApp.showAlert) {
            window.TelegramWebApp.showAlert(errorMsg);
        } else {
            alert(errorMsg);
        }
        console.error('currentTelegramId is null/undefined');
        return;
    }
    
    // –¢–∞–∫—Ç–∏–ª—å–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å –¥–ª—è Telegram
    if (window.TelegramWebApp && window.TelegramWebApp.hapticFeedback) {
        window.TelegramWebApp.hapticFeedback('medium');
    }
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ –∏ –±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏
    $('#loadingIndicator').show();
    $('#nextButton').prop('disabled', true);
    
    // –ë–ª–æ–∫–∏—Ä—É–µ–º MainButton –µ—Å–ª–∏ –æ–Ω–∞ –µ—Å—Ç—å
    if (window.TelegramWebApp && window.TelegramWebApp.MainButton) {
        window.TelegramWebApp.MainButton.hideProgress();
        window.TelegramWebApp.MainButton.showProgress();
    }
    
    console.log('–û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç:', {
        telegramId: currentTelegramId,
        answer: answerText,
        questionId: currentQuestionData?.question?.id
    });
    
    try {
        const response = await fetch(`${API_BASE_URL}/api/user/${currentTelegramId}/answer`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                text_answer: answerText,
                answer_type: 'text'
            })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            // –¢–∞–∫—Ç–∏–ª—å–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å –ø—Ä–∏ —É—Å–ø–µ—Ö–µ
            if (window.TelegramWebApp && window.TelegramWebApp.hapticFeedback) {
                window.TelegramWebApp.hapticFeedback('success');
            }
            
            if (data.status === 'next_question') {
                // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –≤–æ–ø—Ä–æ—Å—É
                currentQuestionData = {
                    question: data.next_question,
                    progress: data.progress,
                    user: currentQuestionData.user
                };
                displayQuestion(currentQuestionData);
                
                // –û—á–∏—â–∞–µ–º textarea
                $('#questionArea').val('');
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É—Å–ø–µ—à–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
                showSuccessMessage('–û—Ç–≤–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω!');
                
            } else if (data.status === 'test_completed') {
                // –¢–µ—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω
                const message = data.message || '–¢–µ—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω!';
                if (window.TelegramWebApp && window.TelegramWebApp.showAlert) {
                    window.TelegramWebApp.showAlert(message);
                } else {
                    alert(message);
                }
                setTimeout(() => {
                    window.location.href = 'download.html';
                }, 1500);
            }
        } else {
            console.error('Error saving answer:', data.error);
            const errorMsg = '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –æ—Ç–≤–µ—Ç–∞: ' + data.error;
            if (window.TelegramWebApp && window.TelegramWebApp.showAlert) {
                window.TelegramWebApp.showAlert(errorMsg);
            } else {
                alert(errorMsg);
            }
        }
    } catch (error) {
        console.error('Error saving answer:', error);
        const errorMsg = '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –æ—Ç–≤–µ—Ç–∞';
        if (window.TelegramWebApp && window.TelegramWebApp.showAlert) {
            window.TelegramWebApp.showAlert(errorMsg);
        } else {
            alert(errorMsg);
        }
    } finally {
        // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ –∏ —Ä–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏
        $('#loadingIndicator').hide();
        $('#nextButton').prop('disabled', false);
        
        // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º MainButton –µ—Å–ª–∏ –æ–Ω–∞ –µ—Å—Ç—å
        if (window.TelegramWebApp && window.TelegramWebApp.MainButton) {
            window.TelegramWebApp.MainButton.hideProgress();
        }
    }
}

// –ü–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
function showSuccessMessage(message) {
    const successDiv = $('<div>')
        .text(message)
        .css({
            position: 'fixed',
            top: '20px',
            left: '50%',
            transform: 'translateX(-50%)',
            background: '#4CAF50',
            color: 'white',
            padding: '10px 20px',
            borderRadius: '5px',
            zIndex: 1000
        });
    
    $('body').append(successDiv);
    
    setTimeout(() => {
        successDiv.fadeOut(() => successDiv.remove());
    }, 2000);
}

// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–Ω–æ–ø–æ–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
$(document).ready(function() {
    console.log('üîß –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ª–æ–≥–∏–∫–∏ –∫–Ω–æ–ø–æ–∫ –≤ question.html');
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–ø—É—â–µ–Ω—ã –ª–∏ –º—ã –≤ Telegram Web App
    const isInTelegram = !!(window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initData);
    console.log('üì± –ó–∞–ø—É—â–µ–Ω–æ –≤ Telegram Web App:', isInTelegram);
    
    if (isInTelegram) {
        // –í Telegram - —Å–∫—Ä—ã–≤–∞–µ–º HTML –∫–Ω–æ–ø–∫—É –∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º MainButton
        console.log('üì± –†–µ–∂–∏–º Telegram: —Å–∫—Ä—ã–≤–∞–µ–º HTML –∫–Ω–æ–ø–∫—É, –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º MainButton');
        $('#nextButton').hide();
        
        // –§—É–Ω–∫—Ü–∏—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ MainButton
        function setupTelegramMainButton() {
            if (window.TelegramWebApp && window.TelegramWebApp.MainButton) {
                console.log('‚öôÔ∏è –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º Telegram MainButton');
                
                // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –µ—Å–ª–∏ –µ—Å—Ç—å
                try {
                    window.TelegramWebApp.offEvent('mainButtonClicked', submitAnswer);
                } catch (e) {
                    console.log('üí° –°—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã (—ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ)');
                }
                
                // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
                window.TelegramWebApp.MainButton.setText('–°–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å');
                window.TelegramWebApp.MainButton.show();
                
                // –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –Ω–æ–≤—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
                window.TelegramWebApp.onEvent('mainButtonClicked', submitAnswer);
                
                console.log('‚úÖ Telegram MainButton –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞');
            } else {
                console.log('‚ùå TelegramWebApp.MainButton –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞');
            }
        }
        
        // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º MainButton —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π
        setTimeout(setupTelegramMainButton, 100);
        setTimeout(setupTelegramMainButton, 500);
        
    } else {
        // –í –æ–±—ã—á–Ω–æ–º –±—Ä–∞—É–∑–µ—Ä–µ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º HTML –∫–Ω–æ–ø–∫—É –∏ —Å–∫—Ä—ã–≤–∞–µ–º MainButton
        console.log('üåê –†–µ–∂–∏–º –±—Ä–∞—É–∑–µ—Ä–∞: –∏—Å–ø–æ–ª—å–∑—É–µ–º HTML –∫–Ω–æ–ø–∫—É');
        $('#nextButton').show();
        
        // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Å–∫—Ä—ã–≤–∞–µ–º MainButton –µ—Å–ª–∏ –æ–Ω–∞ –ø–æ—è–≤–∏–ª–∞—Å—å
        function forceHideMainButton() {
            if (window.TelegramWebApp && window.TelegramWebApp.MainButton) {
                window.TelegramWebApp.MainButton.hide();
                console.log('üö´ MainButton –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Å–∫—Ä—ã—Ç–∞ –≤ –±—Ä–∞—É–∑–µ—Ä–Ω–æ–º —Ä–µ–∂–∏–º–µ');
            }
        }
        
        setTimeout(forceHideMainButton, 100);
        setTimeout(forceHideMainButton, 500);
        setTimeout(forceHideMainButton, 1000);
    }
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ Enter –≤ textarea
    $('#questionArea').on('keydown', function(e) {
        if (e.ctrlKey && e.keyCode === 13) { // Ctrl+Enter
            submitAnswer();
        }
    });
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤–æ–ø—Ä–æ—Å
    loadCurrentQuestion();
    
    // –î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è - —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π ID
    if (!localStorage.getItem('test_telegram_id')) {
        localStorage.setItem('test_telegram_id', '123456789');
    }
    
    console.log('‚úÖ –õ–æ–≥–∏–∫–∞ –∫–Ω–æ–ø–æ–∫ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞ –¥–ª—è question.html');
});
</script>
</body>
</html>